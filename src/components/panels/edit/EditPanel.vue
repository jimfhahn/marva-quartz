<template>

  <!-- Add v-if check for activeProfile and rtOrder -->
  <template v-if="activeProfile && activeProfile.rtOrder">
    <template v-if="preferenceStore.returnValue('--b-edit-main-splitpane-edit-switch-between-resource-button') === true">

        <div style="text-align: right;">
          <button @click="userActiveResourceName = profileName" v-for="profileName in this.activeProfile.rtOrder" :class="{'activeResourceButton': (activeResourceName === profileName)}">
            {{profileName.split(':').slice(-1)[0]}}
          </button>
        </div>

    </template>
    <div

      v-for="profileName in this.activeProfile.rtOrder"
      :key="profileName"
      :class="{'edit-panel-work': (profileName.split(':').slice(-1)[0] == 'Work'), 'edit-panel-instance': (profileName.split(':').slice(-1)[0] == 'Instance'), 'edit-panel-item': (profileName.split(':').slice(-1)[0].includes('Item')), 'edit-panel-instance-secondary': (profileName.split(':').slice(-1)[0].indexOf('_') > -1 && !profileName.split(':').slice(-1)[0].includes('Item')), 'edit-panel-scroll-x-parent': preferenceStore.returnValue('--b-edit-main-splitpane-edit-scroll-x')}">
            <!-- Add checks for activeProfile.rt[profileName] -->
            <template v-if="activeProfile.rt[profileName]">
              <template v-if="instanceMode == true && (profileName.indexOf(':Instance') > -1 || profileName.indexOf(':Item') > -1)">
                <template v-if="profileName.includes(':Instance') && (!layoutActiveFilter || (layoutActiveFilter && Object.keys(layoutActiveFilter['properties']).includes(profileName)))">
                      <div>
                          <span class="instanceIdentifer">{{ instanceLabel(profileName) }}: {{ activeProfile.rt[profileName].URI.split("/").at(-1) }}</span>
                          <button class="instanceDeleteButton" v-if="showDeleteInstanceButton(profileName)" @click="showDeleteInstanceModal(profileName)">Delete Instance?</button>
                      </div>
                </template>
                <template v-if="profileName.includes(':Item') && (!layoutActiveFilter || (layoutActiveFilter && Object.keys(layoutActiveFilter['properties']).includes(profileName)))">
                      <div>
                          <span class="instanceIdentifer">{{ instanceLabel(profileName) }}: {{ activeProfile.rt[profileName].URI.split("/").at(-1) }}</span>
                          <button class="instanceDeleteButton" v-if="showDeleteInstanceButton(profileName)" @click="showDeleteInstanceModal(profileName)">Delete Item</button>
                      </div>
                </template>
                  <template v-if="((preferenceStore.returnValue('--b-edit-main-splitpane-edit-switch-between-resource-button') === false) || (preferenceStore.returnValue('--b-edit-main-splitpane-edit-switch-between-resource-button') === true && profileName == activeResourceName ) )">
                    <!-- Add checks for activeProfile.rt[profileName].ptOrder and pt -->
                    <div v-if="activeProfile.rt[profileName].ptOrder && activeProfile.rt[profileName].pt" v-for="(profileCompoent,idx) in activeProfile.rt[profileName].ptOrder"
                          :key="profileCompoent">
                        <template v-if="activeProfile.rt[profileName].pt[profileCompoent]">
                          <template v-if="(!preferenceStore.returnValue('--c-general-ad-hoc') || (createLayoutMode && !layoutActive)) || (layoutActive || (preferenceStore.returnValue('--c-general-ad-hoc') && profileStore.emptyComponents[profileName] && !profileStore.emptyComponents[profileName].includes(profileCompoent) ))">
                          <template v-if="!activeProfile.rt[profileName].pt[profileCompoent].deleted && !hideAdminField(activeProfile.rt[profileName].pt[profileCompoent], profileName)">
                            <template v-if="(createLayoutMode && layoutActive) || layoutActive == false || (layoutActive == true && layoutActiveFilter && layoutActiveFilter.properties[profileName] && includeInLayout(activeProfile.rt[profileName].pt[profileCompoent].id, layoutActiveFilter['properties'][profileName])) ">

                              <template v-if="(preferenceStore.returnValue('--b-edit-main-splitpane-edit-adhoc-mode') === true && activeProfile.rt[profileName].pt[profileCompoent].canBeHidden === false) || preferenceStore.returnValue('--b-edit-main-splitpane-edit-adhoc-mode') === false">
                                <div
                                  :class="[
                                    'component-label 1',
                                    {'label-bold': preferenceStore.returnValue('--b-edit-main-splitpane-edit-show-field-labels-bold')},
                                    validationHighlightClassForGuid(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])
                                  ]"
                                  :title="validationTooltip(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                >
                                    <input v-if="!createLayoutMode && preferenceStore.copyMode && !activeProfile.rt[profileName].pt[profileCompoent].propertyLabel.includes('Admin')" type="checkbox" class="copy-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                    <input v-if="createLayoutMode" type="checkbox" class="layout-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                    {{activeProfile.rt[profileName].pt[profileCompoent].propertyLabel}}
                                    <span
                                      v-if="validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                      class="validation-pill"
                                      :class="validationBadgeClass(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                    >
                                      {{ validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid']) }}
                                    </span>
                                </div>
                                <Main
                                  :guid="activeProfile.rt[profileName].pt[profileCompoent]['@guid']"
                                  :level="0"
                                  :id="activeProfile.rt[profileName].pt[profileCompoent].id"
                                  :parentId="activeProfile.rt[profileName].pt[profileCompoent].parentId"
                                  :readOnly="isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])" />
                              </template>
                            </template>
                          </template>

                          </template>
                        </template> <!-- End v-if activeProfile.rt[profileName].pt[profileCompoent] -->
                      </div>
                  </template>


                </template>
            <template v-if="instanceMode == false">
              <template v-if="profileName.includes(':Instance') && !this.dualEdit && (!layoutActiveFilter || (layoutActiveFilter && Object.keys(layoutActiveFilter['properties']).includes(profileName)))">
                  <div class="instanceInfoWrapper">
                      <span class="instanceIdentifer">{{ instanceLabel(profileName) }}: {{ activeProfile.rt[profileName].URI.split("/").at(-1) }}</span>
                      <button class="instanceDeleteButton" v-if="showDeleteInstanceButton(profileName)" @click="showDeleteInstanceModal(profileName)">Delete Instance!</button>
                  </div>
              </template>

              <template v-if="profileName.includes(':Item') && !this.dualEdit && (!layoutActiveFilter || (layoutActiveFilter && Object.keys(layoutActiveFilter['properties']).includes(profileName)))">
                  <div class="instanceInfoWrapper">
                      <span class="instanceIdentifer">{{ instanceLabel(profileName) }}: {{ activeProfile.rt[profileName].URI.split("/").at(-1) }}</span>
                      <button class="instanceDeleteButton" v-if="showDeleteInstanceButton(profileName)" @click="showDeleteInstanceModal(profileName)">Delete Item</button>
                  </div>
              </template>

              <!-- Add checks for activeProfile.rt[profileName].ptOrder and pt -->
              <template v-if="activeProfile.rt[profileName].ptOrder && activeProfile.rt[profileName].pt" v-for="(profileCompoent,idx) in activeProfile.rt[profileName].ptOrder" :key="profileCompoent">
                <template v-if="activeProfile.rt[profileName].pt[profileCompoent]">
                  <template v-if="(createLayoutMode && layoutActive) || layoutActive == false || (layoutActive == true && layoutActiveFilter && layoutActiveFilter.properties[profileName] && includeInLayout(activeProfile.rt[profileName].pt[profileCompoent].id, layoutActiveFilter['properties'][profileName])) ">
                    <template v-if="!hideProps.includes(activeProfile.rt[profileName].pt[profileCompoent].propertyURI)">

                      <template v-if="(preferenceStore.returnValue('--b-edit-main-splitpane-edit-adhoc-mode') === true && activeProfile.rt[profileName].pt[profileCompoent].canBeHidden === false) || preferenceStore.returnValue('--b-edit-main-splitpane-edit-adhoc-mode') === false">

                        <template v-if="((preferenceStore.returnValue('--b-edit-main-splitpane-edit-switch-between-resource-button') === false) || (preferenceStore.returnValue('--b-edit-main-splitpane-edit-switch-between-resource-button') === true && profileName == activeResourceName ))">

                          <template v-if="!activeProfile.rt[profileName].pt[profileCompoent].deleted && !hideAdminField(activeProfile.rt[profileName].pt[profileCompoent], profileName)">
                            <!-- if createLatoutMode is active, and there is an active layout, show everything -->
                            <div v-if="(!preferenceStore.returnValue('--c-general-ad-hoc') || (createLayoutMode && !layoutActive)) || (layoutActive || (preferenceStore.returnValue('--c-general-ad-hoc') && profileStore.emptyComponents[profileName] && !profileStore.emptyComponents[profileName].includes(profileCompoent)))" :class="{ 'inline-mode' : (preferenceStore.returnValue('--b-edit-main-splitpane-edit-inline-mode')), 'edit-panel-scroll-x-child': preferenceStore.returnValue('--b-edit-main-splitpane-edit-scroll-x'), 'read-only': isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])}">
                              <template v-if="this.dualEdit == false">
                                <template v-if="preferenceStore.returnValue('--b-edit-main-splitpane-edit-shortcode-display-mode') == false && preferenceStore.returnValue('--b-edit-main-splitpane-edit-inline-mode') == false">
                                  <div
                                    :class="[
                                      'component-label 2',
                                      {'label-bold': preferenceStore.returnValue('--b-edit-main-splitpane-edit-show-field-labels-bold')},
                                      validationHighlightClassForGuid(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])
                                    ]"
                                    :title="validationTooltip(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                  >
                                    <input v-if="!createLayoutMode && preferenceStore.copyMode && !activeProfile.rt[profileName].pt[profileCompoent].propertyLabel.includes('Admin')" type="checkbox" class="copy-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                    <input v-if="createLayoutMode" type="checkbox" class="layout-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" :value="profileName" :checked="layoutActiveFilter && layoutActiveFilter['properties'][profileName] && includeInLayout(activeProfile.rt[profileName].pt[profileCompoent].id, layoutActiveFilter['properties'][profileName])" />
                                    {{activeProfile.rt[profileName].pt[profileCompoent].propertyLabel}}
                                    <span
                                      v-if="validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                      class="validation-pill"
                                      :class="validationBadgeClass(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                    >
                                      {{ validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid']) }}
                                    </span>
                                    <span v-if="isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])"> (HISTORICAL - READ ONLY) <a style="color:black" href="#" @click="showDebug($event,activeProfile.rt[profileName].pt[profileCompoent])">debug</a></span>
                                  </div>
                                </template>
                            </template>
                            <template v-if="this.dualEdit == true">
                                <template v-if="preferenceStore.returnValue('--b-edit-main-splitpane-edit-shortcode-display-mode') == false && preferenceStore.returnValue('--b-edit-main-splitpane-edit-inline-mode') == false && (profileName.indexOf(':Instance') == -1 && profileName.indexOf(':Item') == -1 )">
                                  <div
                                    :class="[
                                      'component-label 3',
                                      {'label-bold': preferenceStore.returnValue('--b-edit-main-splitpane-edit-show-field-labels-bold')},
                                      validationHighlightClassForGuid(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])
                                    ]"
                                    :title="validationTooltip(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                  >
                                  <input v-if="!createLayoutMode && preferenceStore.copyMode && !activeProfile.rt[profileName].pt[profileCompoent].propertyLabel.includes('Admin')" type="checkbox" class="copy-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                  <input v-if="createLayoutMode" type="checkbox" class="layout-selection" :id="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                  {{activeProfile.rt[profileName].pt[profileCompoent].propertyLabel}}
                                    <span
                                      v-if="validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                      class="validation-pill"
                                      :class="validationBadgeClass(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])"
                                    >
                                      {{ validationBadgeLabel(activeProfile.rt[profileName].pt[profileCompoent]['@guid']) }}
                                    </span>
                                    <span v-if="isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])"> (HISTORICAL - READ ONLY) <a style="color:black" href="#" @click="showDebug($event,activeProfile.rt[profileName].pt[profileCompoent])">debug</a></span>
                                  </div>
                                </template>
                            </template>

                              <template v-if="preferenceStore.returnValue('--b-edit-main-splitpane-edit-inline-mode')">
                                <div v-if="profileName.split(':').slice(-1)[0] == 'Work'" class="inline-mode-resource-color-work">&nbsp;</div>
                                <div v-if="profileName.indexOf(':Instance') > -1 && profileName.indexOf(':Item') == -1" class="inline-mode-resource-color-instance">&nbsp;</div>
                                <template v-if="profileStore.cammModeErrors[activeProfile.rt[profileName].pt[profileCompoent]['@guid']]">

                                  <span :class="{'material-icons' : true, 'inline-mode-error-icon': true, 'simptip-position-right':true, 'inline-mode-mian-button-has-ref' : profileStore.ptHasRefComponent(activeProfile.rt[profileName].pt[profileCompoent])}" @click="showErrors(activeProfile.rt[profileName].pt[profileCompoent]['@guid'])">warning</span>

                                </template>
                                <template v-else>
                                  <button @mouseenter="inlineRowButtonMouseEnter" :class="{'inline-mode-mian-button': true, 'inline-mode-mian-button-has-ref' : profileStore.ptHasRefComponent(activeProfile.rt[profileName].pt[profileCompoent]) }"></button>
                                </template>

                              </template>

                              <!-- index == -1 means it's the work, so just add the work -->
                              <Main v-if="profileName.indexOf(':Instance') == -1 && profileName.indexOf(':Item') == -1"
                                :guid="activeProfile.rt[profileName].pt[profileCompoent]['@guid']"
                                :level="0"
                                :id="activeProfile.rt[profileName].pt[profileCompoent].id"
                                :parentId="activeProfile.rt[profileName].pt[profileCompoent].parentId"
                                :readOnly="isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])" />

                              <!-- If it's not in dual mode add the instances too -->
                              <Main v-if="this.dualEdit == false && (profileName.indexOf(':Instance') > -1 || profileName.indexOf(':Item') > -1)"
                                :guid="activeProfile.rt[profileName].pt[profileCompoent]['@guid']"
                                :level="0"
                                :id="activeProfile.rt[profileName].pt[profileCompoent].id"
                                :parentId="activeProfile.rt[profileName].pt[profileCompoent].parentId"
                                :readOnly="isReadOnly(activeProfile.rt[profileName].pt[profileCompoent])" />

                                  <template v-if="preferenceStore.returnValue('--b-edit-main-splitpane-edit-inline-mode')">
                                    <InlineModeAddField :guid="activeProfile.rt[profileName].pt[profileCompoent]['@guid']" />
                                  </template>

                              </div>
                            </template>
                          </template>
                        </template>
                      </template>
                    </template>
                  </template>
                </template> <!-- End v-if activeProfile.rt[profileName].pt[profileCompoent] -->
              </template>
            </template> <!-- End v-if activeProfile.rt[profileName] -->


            <select style="margin-left:40px; margin-bottom:0px" @change="addProperty($event,profileName)" v-if="activeProfile.rt[profileName] && activeProfile.rt[profileName].ptOrder && activeProfile.rt[profileName].pt && preferenceStore.returnValue('--b-edit-main-splitpane-edit-adhoc-mode') === true">
              <option value="home" selected>Add Property</option>
              <template v-for="(profileCompoent,idx) in activeProfile.rt[profileName].ptOrder">
                <option v-if="activeProfile.rt[profileName].pt[profileCompoent] && activeProfile.rt[profileName].pt[profileCompoent].canBeHidden == true" :value="profileCompoent" >{{activeProfile.rt[profileName].pt[profileCompoent].propertyLabel}}</option>
              </template>
            </select>
    </div>
  </template>
  <template v-else>
      <!-- Optional: Show a loading state or message -->
      <div>Loading editor...</div>
  </template>

</template>


<script>

  import { usePreferenceStore } from '@/stores/preference'
  import { useProfileStore } from '@/stores/profile'
  import { mapStores, mapState, mapWritableState } from 'pinia'

  import InlineModeAddField from "@/components/panels/edit/fields/helpers/InlineModeAddField.vue";



  // import Main from "@/components/panels/edit/fields/Main.vue";



  export default {
    components: {InlineModeAddField  },
    props: {

      instanceMode: Boolean,
      dualEdit: Boolean,

    },
    data() {
      return {
        userActiveResourceName: null,
        hideProps:[
          'http://id.loc.gov/ontologies/bibframe/hasInstance',
          'http://id.loc.gov/ontologies/bibframe/instanceOf',
          'http://id.loc.gov/ontologies/bibframe/hasItem'
        ]

      }
    },
    computed: {
      // other computed properties
      // ...
      ...mapStores(usePreferenceStore),
      ...mapStores(useProfileStore),


      ...mapState(usePreferenceStore, ['styleDefault', 'layoutActive', 'layoutActiveFilter', 'createLayoutMode']),

      // gives read access to this.count and this.double
      // ...mapState(usePreferenceStore, ['profilesLoaded']),
      ...mapState(useProfileStore, ['profilesLoaded','activeProfile','activeComponent', 'dataChanged']),
      ...mapWritableState(usePreferenceStore, ['debugModalData','showDebugModal']),
      ...mapWritableState(useProfileStore, ['emptyComponents']),

      activeResourceName(){

        if (this.userActiveResourceName===null){
          if (this.activeProfile && this.activeProfile.rtOrder){
            return this.activeProfile.rtOrder[0]
          }
        }else{
          return this.userActiveResourceName
        }

      },


    },

    methods: {

        resolveValidationHighlight(guid) {
          if (!guid) {
            return null;
          }
          if (this.profileStore && typeof this.profileStore.getValidationHighlight === 'function') {
            return this.profileStore.getValidationHighlight(guid);
          }
          if (this.profileStore && this.profileStore.validationHighlights) {
            return this.profileStore.validationHighlights[guid] || null;
          }
          return null;
        },

        validationHighlightClassForGuid(guid) {
          const highlight = this.resolveValidationHighlight(guid);
          if (!highlight) {
            return {};
          }
          const severity = (highlight.severity || 'INFO').toUpperCase();
          return {
            'validation-highlight': true,
            'validation-error': severity === 'ERROR',
            'validation-warning': severity === 'WARNING',
            'validation-success': severity === 'SUCCESS',
            'validation-info': severity === 'INFO'
          };
        },

        validationBadgeLabel(guid) {
          const highlight = this.resolveValidationHighlight(guid);
          if (!highlight || !highlight.severity) {
            return null;
          }
          return highlight.severity.charAt(0);
        },

        validationBadgeClass(guid) {
          const highlight = this.resolveValidationHighlight(guid);
          if (!highlight || !highlight.severity) {
            return {};
          }
          const severity = highlight.severity.toUpperCase();
          return {
            'pill-error': severity === 'ERROR',
            'pill-warning': severity === 'WARNING',
            'pill-success': severity === 'SUCCESS',
            'pill-info': severity === 'INFO'
          };
        },

        validationTooltip(guid) {
          const highlight = this.resolveValidationHighlight(guid);
          if (!highlight || !Array.isArray(highlight.issues) || highlight.issues.length === 0) {
            return null;
          }
            return highlight.issues.map((issue) => `${issue.severity}: ${issue.message}`).join('\n');
        },


        showErrors(guid){

          console.log(guid)
          let msg = this.profileStore.cammModeErrors[guid].join("\n")
          alert(msg)


        },

        showDebug: function(event,data){


          this.debugModalData= this.profileStore.returnStructureByComponentGuid(data['@guid']);
          this.showDebugModal=true

          event.preventDefault()
          return false

        },

        // Whether or not a component that isn't explicitly in that layout should be included
        // this is important for adding components when a layout is open
        includeInLayout: function(checkId, targets){
          if (!targets){ return false }
          if (targets.includes(checkId)){ return true}
          //otherwise, get the base of the checkId to compare
          let breakPoint = checkId.lastIndexOf("_")
          let base = checkId.slice(0, breakPoint)
          if (targets.includes(base)){ return true}

          return false

        },

        isReadOnly: function(component){

          if (component.adminMetadataType && component.adminMetadataType == 'secondary'){
            return true
          }

          if (component.propetyLabel == 'Local identifier'){
            return true
          }

          return false

        },

        //We only want the editable admin field under instances to show up
        // Don't show READONLY ADMIN fields in the instance, Don't show any admin fields in the work
        hideAdminField: function(component, profileName){

          let readOnly = this.isReadOnly(component)
          let isWork = profileName.includes(':Work')
          let isAdminField = component.propertyURI.includes('adminMetadata')

          return (readOnly) || (isWork && isAdminField )
        },

        inlineRowButtonMouseEnter: function(event){
          console.log(event)

        },

        addProperty: function(event,profile){


          this.profileStore.setPropertyVisible(profile,event.target.value)
          event.target.value = "home"
        },


        getBibId: function(){
            // Add check for activeProfile and rt
            if (!this.activeProfile || !this.activeProfile.rt) {
              return false;
            }
            for (let rt in this.activeProfile.rt){
              // Add check for activeProfile.rt[rt]
              if (!this.activeProfile.rt[rt]) continue;

              let type = rt.split(':').slice(-1)[0]
              let url = this.activeProfile.rt[rt].URI

              // populate the title
              if (type=='Instance'){
                let bibId =  url.split("/")[url.split('/').length - 1]
                return bibId
              }
            }
            return false
        },

        //Add the BibId to the title
        populateTitle: function(){
            if (!this.activeProfile) {
                console.warn("populateTitle: activeProfile is null");
                return;
            }
            let eId = this.activeProfile.eId
            let bibId = this.getBibId()

            if (bibId && eId != bibId){
                document.title = `Marva | ${bibId}`;
            }
        },

        //only able to delete the instances they create
        showDeleteInstanceButton: function(profileName){
          // Add check for activeProfile and rt[profileName]
          // return this.activeProfile?.rt?.[profileName]?.deletable // Optional chaining might be cleaner
          if (!this.activeProfile || !this.activeProfile.rt || !this.activeProfile.rt[profileName]) {
            return false; // Cannot delete if profile/rt doesn't exist
          }
          return true // Assuming deletable logic is simplified to always true if exists
        },

        showDeleteInstanceModal: function(profileName){
          // Add check for activeProfile and rtOrder/rt
          if (!this.activeProfile || !this.activeProfile.rtOrder || !this.activeProfile.rt) {
            console.warn("showDeleteInstanceModal: activeProfile not ready.");
            return;
          }
          let resourceType = profileName.includes("Item") ? "Item" : "Instance"
            if (window.confirm("Do you really want to delete this " + resourceType + "?")){
                // remove from rtOrder
                const targetIndex = this.activeProfile.rtOrder.indexOf(profileName)
                if (targetIndex > -1) { // Ensure it exists before splicing
                  this.activeProfile.rtOrder.splice(targetIndex, 1)
                }

                // Remove from ad hoc
                if (Object.keys(this.emptyComponents).includes(profileName)){
                  delete this.emptyComponents[profileName]
                }

                // remove the profile
                delete this.activeProfile.rt[profileName]
                this.profileStore.dataChanged()
            }
        },

        instanceLabel: function(profileName){
          // Add check for activeProfile and rt[profileName]
          if (!this.activeProfile || !this.activeProfile.rt || !this.activeProfile.rt[profileName]) {
            return profileName.includes(":Item") ? "Item" : "Instance"; // Fallback label
          }
          if (profileName.includes(":Item")){
            return "Item"
          }
          try{
              if (this.activeProfile.rt[profileName]["@type"] && this.activeProfile.rt[profileName]["@type"].includes("Secondary")){ // Added check for @type existence
                  return "Secondary Instance"
              }
              return "Instance"
          } catch(err){
              return "Instance"
          }
        }
    },

    watch:{

      activeComponent(newVal){



            this.$nextTick(() => {
              window.setTimeout(()=> {
                document.getElementById(`edit_${newVal.parentId}_${newVal.id}`).scrollIntoView({behavior: "smooth", block:"start"});


                document.getElementById(`edit_${newVal.parentId}_${newVal.id}`).querySelector('input,textarea').focus()

                for (let el of document.getElementById(`edit_${newVal.parentId}_${newVal.id}`).querySelectorAll('input,textarea')){
                  el.style.transition = "background 500ms"
                  el.style.background='yellow'
                }
                window.setTimeout(()=> {
                  for (let el of document.getElementById(`edit_${newVal.parentId}_${newVal.id}`).querySelectorAll('input,textarea')){
                    el.style.background='transparent'
                  }
                },1000);


              },10);
            });



      }


    },


    mounted: function(){
        //populate when loading from a search
        this.populateTitle()
    },

    updated: function(){
        let bibId = this.getBibId()
		// Add the ID to the title when loading from "Your Records"

        if (!document.title.includes(bibId)){
            this.populateTitle()
        }
    }

  }

</script>
<style scoped>

.validation-highlight {
  border-left: 4px solid #1976d2;
  padding-left: 0.5rem;
}

.validation-error {
  border-color: #b71c1c;
}

.validation-warning {
  border-color: #f57c00;
}

.validation-success {
  border-color: #2e7d32;
}

.validation-info {
  border-color: #1976d2;
}

.validation-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  margin-left: 0.5rem;
  padding: 0.1rem 0.45rem;
  border-radius: 999px;
  font-size: 0.65rem;
  font-weight: 600;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.validation-pill.pill-error {
  background-color: rgba(183, 28, 28, 0.12);
  color: #b71c1c;
}

.validation-pill.pill-warning {
  background-color: rgba(245, 124, 0, 0.15);
  color: #f57c00;
}

.validation-pill.pill-success {
  background-color: rgba(46, 125, 50, 0.15);
  color: #2e7d32;
}

.validation-pill.pill-info {
  background-color: rgba(25, 118, 210, 0.12);
  color: #1976d2;
}

.inline-mode-error-icon{
  font-size: 16px;
  color:red;
  animation-name: grow;
  animation-duration: 1s;
  animation-iteration-count: infinite;
  z-index: 1000;
  margin-right: 17px;
}

.read-only{
  padding-left: 2em;
}
.edit-panel-scroll-x-parent{
  overflow-x: scroll;
}
.edit-panel-scroll-x-child{
  width:1500px;
}



.activeResourceButton{
  background-color: skyblue;
}
.inline-mode-resource-color-work{
  display: inline-block;
  width: 5px;
  margin-right: 5px;
  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-work')");
  content: ' ';
}
.inline-mode-resource-color-instance{
  display: inline-block;
  width: 5px;
  margin-right: 5px;
  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-instance')");
  content: ' ';
}
.inline-mode-mian-button{
  height: 15px;
  background-color: transparent;
  border: solid 1px #dcdcdc;
  margin-right: 19px;
}

.inline-mode-mian-button-has-ref{
  margin-right: 0;
}
.inline-mode-mian-button:hover{
  background-color: cornflowerblue;
  cursor: pointer;
}
.inline-mode{
  background-color: white;
  border-top: solid 1px whitesmoke;
}

.edit-panel-work{
  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-work')") !important;
}

.edit-panel-instance{
  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-instance')") !important;
  padding-bottom: 5em;
}
.edit-panel-item{
  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-item')") !important;
}
.edit-panel-instance-secondary{

  background-color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-background-color-instance-secondary')") !important;

}

.component-label{
  font-size: 0.85em;
  color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-component-label-color')");
}
.label-bold{
  font-weight: bold;
}

div.instanceInfoWrapper {
    padding: 5px;
}

.instanceIdentifer {
    font-weight: bold;
    color: v-bind("preferenceStore.returnValue('--c-edit-main-splitpane-edit-component-label-color')");

}

.instanceDeleteButton {
    float: right;
    margin-right: 5px;
}



@keyframes grow {
    from {
        transform: scale(1);
    }
    to {
        transform: scale(1.5);
    }
}


</style>
